<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ë¹„ì¦ˆë©”ì‹œì§€ ì„œë¹„ìŠ¤ ê°±ì‹  ê´€ë¦¬ (v1.0 mockUp)</title>
    <style>
        :root {
            --bg: #f7f8fb;
            --ink: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --line: #e5e7eb;
            --primary: #2563eb;
            --accent: #10b981;
            --warn: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
            background: var(--bg);
            color: var(--ink)
        }

        header {
            background: #1f2937;
            color: #fff;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px
        }

        header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: 700
        }

        header .crumbs {
            font-size: 12px;
            color: #d1d5db
        }

        .container {
            margin: 0 auto;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
            width: 100%;
            /* ğŸ”¹í™”ë©´ ë„“ì´ì˜ 90% */
            max-width: 100%;
            margin: 0 auto;
            /* ğŸ”¹ê°€ìš´ë° ì •ë ¬ */
            overflow-x: auto;
            /* ğŸ”¹ë‚´ë¶€ ê·¸ë¦¬ë“œê°€ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ í—ˆìš© */
            box-sizing: border-box;
        }

        /* 3í–‰ ê·¸ë¦¬ë“œ + ì—´ í­ í´ë¨í”„(ì˜¤ë²„í”Œë¡œ ë°©ì§€) */
        .toolbar {
            display: grid;
            grid-auto-rows: 36px;
            /* [í•„í„°ì—´ 6ì¹¸(ìµœëŒ€ 220px)] [ì¢Œì¸¡ì—¬ë°± 1fr] [ìš°ì¸¡ë²„íŠ¼ 3ì¹¸(ìµœëŒ€ 140px)] */
            grid-template-columns: repeat(6, fit-content(220px)) 1fr repeat(3, fit-content(140px));
            column-gap: 10px;
            row-gap: 10px;
            align-items: center;
            overflow: hidden;
            /* ì•„ì£¼ ê¸´ ë‚´ìš©ìœ¼ë¡œ ì¸í•œ ë„˜ì¹¨ ë°©ì§€ */
        }

        /* 1í–‰: ë°œì†¡ì—¬ë¶€ê¹Œì§€ + D-30/60 + ê²€ìƒ‰/ì´ˆê¸°í™” */
        #qId,
        #qCompany,
        #qStatus,
        #qSent,
        #qDue30,
        #qDue60,
        #btnSearch,
        #btnReset {
            grid-row: 1;
        }

        /* 2í–‰: ë‚ ì§œ ~ í…œí”Œë¦¿(ì¢Œì¸¡ ì •ë ¬) */
        #qFrom,
        #qTo,
        .pill,
        #btnTpl {
            grid-row: 2;
        }

        /* 3í–‰: ë 3ì¹¸ì— ê³ ì • + ìš°ì¸¡ ì •ë ¬ */
        #btnBulkMail {
            grid-row: 3;
            grid-column: -3;
            justify-self: end;
        }

        #btnBulkAlim {
            grid-row: 3;
            grid-column: -2;
            justify-self: end;
        }

        #btnExport {
            grid-row: 3;
            grid-column: -1;
            justify-self: end;
        }

        .toolbar input[type=text],
        .toolbar input[type=date],
        .toolbar select {
            height: 36px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fff;
            padding: 0 10px;
            min-width: 160px
        }

        .toolbar .check {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 36px;
            padding: 0 10px;
            border: 1px dashed var(--line);
            border-radius: 8px;
            background: #fafafa
        }

        button {
            display: inline-flex;
            /* ë‚´ë¶€ í…ìŠ¤íŠ¸ì— ë§ê²Œ ìë™ í¬ê¸° */
            align-items: center;
            justify-content: center;
            height: 32px;
            /* ì‚´ì§ ë‚®ì¶° ê· í˜• ë§ì¶¤ */
            padding: 0 10px;
            /* ì¢Œìš° ì—¬ë°± ì¤„ì´ê¸° */
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fff;
            font-size: 13px;
            line-height: 1.3;
            cursor: pointer;
            white-space: nowrap;
            /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            width: auto;
            /* ë‚´ìš© ê¸°ë°˜ ë„ˆë¹„ */
            min-width: unset;
            /* min-width ê°•ì œê°’ ì œê±° */
            box-sizing: border-box;
        }

        .check {
            display: inline-flex;
            /* ë‚´ë¶€ í…ìŠ¤íŠ¸ì— ë§ê²Œ ìë™ í¬ê¸° */
            align-items: center;
            justify-content: center;
            height: 32px;
            /* ì‚´ì§ ë‚®ì¶° ê· í˜• ë§ì¶¤ */
            padding: 0 10px;
            /* ì¢Œìš° ì—¬ë°± ì¤„ì´ê¸° */
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fff;
            font-size: 13px;
            line-height: 1.3;
            cursor: pointer;
            white-space: nowrap;
            /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            width: auto;
            /* ë‚´ìš© ê¸°ë°˜ ë„ˆë¹„ */
            min-width: unset;
            /* min-width ê°•ì œê°’ ì œê±° */
            box-sizing: border-box;
        }

        /* ë²„íŠ¼ ê°„ ê°„ê²© ì¡°ê¸ˆ ë„ìš°ê¸° */
        .toolbar button {
            margin-right: 6px;
        }

        button.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff
        }

        button.warn {
            background: var(--warn);
            border-color: var(--warn)
        }

        button.ghost {
            background: transparent
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px
        }

        .grid th,
        .grid td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--line);
            vertical-align: middle
        }

        .grid th {
            background: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 1;
            text-align: left
        }

        .grid th.sort {
            cursor: pointer
        }

        .grid th.sort::after {
            content: "â‡…";
            font-size: 11px;
            color: #9ca3af;
            margin-left: 6px
        }

        .badge {
            display: inline-block;
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 12px;
            background: #fff
        }

        .b-green {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #065f46
        }

        .b-yellow {
            background: #fffbeb;
            border-color: #fde68a;
            color: #92400e
        }

        .b-red {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b
        }

        .muted {
            color: var(--muted)
        }

        .row-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 0 10px;
            height: 26px;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-size: 12px
        }

        .sticky-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        .pagination {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 10px
        }

        .pagination button {
            height: 28px
        }

        .kebab {
            cursor: pointer
        }

        .highlight {
            background: #fff7ed
        }

        /* Modal */
        dialog {
            border: none;
            border-radius: 12px;
            width: min(900px, 95vw);
            padding: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .2)
        }

        .modal {
            padding: 0
        }

        .modal header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #111827;
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px 12px 0 0
        }

        .modal header h3 {
            margin: 0;
            font-size: 15px
        }

        .modal .body {
            padding: 14px;
            max-height: 70vh;
            overflow: auto
        }

        .modal .footer {
            padding: 12px 14px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid var(--line);
            background: #fafafa;
            border-radius: 0 0 12px 12px
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 8px
        }

        .tabs button {
            height: 32px
        }

        .tabs button.active {
            background: #eef2ff;
            border-color: #c7d2fe;
            color: #111827
        }

        .form-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px
        }

        textarea {
            width: 100%;
            min-height: 100px;
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 8px
        }

        input[type=file] {
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 6px;
            background: #fff
        }

        .label {
            font-size: 12px;
            color: #374151
        }

        .table-mini {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px
        }

        .table-mini th,
        .table-mini td {
            border-bottom: 1px solid var(--line);
            padding: 6px 8px
        }

        .right {
            float: right
        }
    </style>
</head>

<body>
    <header>
        <h1>ë¹„ì¦ˆë©”ì‹œì§€ ì„œë¹„ìŠ¤ ê°±ì‹  ê´€ë¦¬</h1>
        <div class="crumbs">ì˜ì—… / ê³ ê° ê´€ë¦¬ / ë¹„ì¦ˆë©”ì‹œì§€ ì„œë¹„ìŠ¤ ê°±ì‹  ê´€ë¦¬</div>
    </header>

    <div class="container">
        <section class="card">
            <div class="toolbar">
                <input id="qId" type="text" placeholder="ê³ ê° ì•„ì´ë”” ê²€ìƒ‰">
                <input id="qCompany" type="text" placeholder="íšŒì‚¬ëª… ê²€ìƒ‰">
                <label class="check"><input id="qDue30" type="checkbox"> ë§Œë£Œì¼ 30ì¼ ì´í•˜</label>
                <label class="check"><input id="qDue60" type="checkbox"> ë§Œë£Œì¼ 60ì¼ ì´í•˜</label>
                <select id="qStatus">
                    <option value="">ì²˜ë¦¬í˜„í™©(ì „ì²´)</option>
                    <option>ëŒ€ê¸°</option>
                    <option>ê³µì§€ ì™„ë£Œ</option>
                    <option>ê°±ì‹  ì™„ë£Œ</option>
                    <option>ë³´ë¥˜</option>
                </select>
                <select id="qSent">
                    <option value="">ë°œì†¡ì—¬ë¶€(ì „ì²´)</option>
                    <option value="mail">ë©”ì¼ ë°œì†¡ë¨</option>
                    <option value="alim">ì•Œë¦¼í†¡ ë°œì†¡ë¨</option>
                    <option value="none">ë¯¸ë°œì†¡</option>
                </select>
                <input id="qFrom" type="date">
                <input id="qTo" type="date">
                <button class="primary" id="btnSearch">ê²€ìƒ‰</button>
                <button class="ghost" id="btnReset">ì´ˆê¸°í™”</button>
                <span class="pill" title="í˜„ì¬ í™œì„± í…œí”Œë¦¿"><strong>í™œì„± í…œí”Œë¦¿:</strong> <span id="activeTplName">ê°±ì‹ 
                        ì•ˆë‚´(1ì°¨)</span></span>
                <button id="btnTpl">í…œí”Œë¦¿ ê´€ë¦¬</button>
                <div style="flex:1"></div>
                <button id="btnBulkMail">ì„ íƒ ë©”ì¼ ë°œì†¡</button>
                <button id="btnBulkAlim">ì„ íƒ ì•Œë¦¼í†¡ ë°œì†¡</button>
                <button class="warn" id="btnExport">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ(Mock)</button>
            </div>

            <div class="sticky-actions">
                <div class="muted" id="resultInfo">ì´ 0ê±´</div>
                <div class="muted">D-45 / D-30 ìë™ ì•Œë¦¼ ëŒ€ìƒ í–‰ì€ í•˜ì´ë¼ì´íŠ¸ë©ë‹ˆë‹¤.</div>
            </div>

            <div style="overflow:auto;max-height:60vh">
                <table class="grid" id="dataGrid">
                    <thead>
                        <tr>
                            <th style="width:34px"><input type="checkbox" id="checkAll"></th>
                            <th class="sort" data-key="id">ê³ ê° ì•„ì´ë””</th>
                            <th class="sort" data-key="company">íšŒì‚¬</th>
                            <th>ì¦ê¶Œë²ˆí˜¸</th>
                            <th class="sort" data-key="period">ë³´ì¦ë³´í—˜ ê¸°ê°„</th>
                            <th class="sort" data-key="remain">ë³´ì¦ë³´í—˜ ë§Œë£Œì¼</th>
                            <th class="sort" data-key="amount">ë³´ì¦ë³´í—˜ ê¸ˆì•¡</th>
                            <th>ìš”ê¸ˆê´€ë¦¬ì</th>
                            <th>ìš”ê¸ˆê´€ë¦¬ì ì—°ë½ì²˜</th>
                            <th>ìš”ê¸ˆê´€ë¦¬ì ì´ë©”ì¼</th>
                            <th>ë©”ì¼ ë°œì†¡ì¼</th>
                            <th>ì•Œë¦¼í†¡ ë°œì†¡ì¼</th>
                            <th>ì²˜ë¦¬í˜„í™©</th>
                            <th style="min-width:220px">ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="pagination" id="pager"></div>
        </section>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <dialog id="dlgDetail">
        <div class="modal">
            <header>
                <h3>ìƒì„¸ ë³´ê¸°</h3>
                <button onclick="closeDetail()">ë‹«ê¸°</button>
            </header>
            <div class="body">
                <div class="tabs">
                    <button data-tab="basic" class="active">ê¸°ë³¸ì •ë³´</button>
                    <button data-tab="ins">ë³´ì¦ë³´í—˜ì •ë³´</button>
                    <button data-tab="logs">ë°œì†¡ì´ë ¥</button>
                    <button data-tab="reply">ê³ ê°ì‘ë‹µ</button>
                </div>
                <div class="tab-panel" id="tab-basic"></div>
                <div class="tab-panel" id="tab-ins" hidden></div>
                <div class="tab-panel" id="tab-logs" hidden></div>
                <div class="tab-panel" id="tab-reply" hidden></div>
            </div>
            <div class="footer">
                <button id="btnDetailMail">ë©”ì¼ ë°œì†¡</button>
                <button id="btnDetailAlim">ì•Œë¦¼í†¡ ë°œì†¡</button>
                <button class="primary" onclick="closeDetail()">í™•ì¸</button>
            </div>
        </div>
    </dialog>

    <!-- ë©”ëª¨ ëª¨ë‹¬ -->
    <dialog id="dlgMemo">
        <div class="modal">
            <header>
                <h3>ë©”ëª¨</h3><button onclick="dlgMemo.close()">ë‹«ê¸°</button>
            </header>
            <div class="body">
                <div class="form-row">
                    <div class="label">ê³ ê°</div>
                    <div id="memoTarget"></div>
                </div>
                <textarea id="memoText" placeholder="ë‚´ë¶€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>
            <div class="footer">
                <button onclick="saveMemo()" class="primary">ì €ì¥</button>
            </div>
        </div>
    </dialog>

    <!-- ë°œì†¡ ëª¨ë‹¬ -->
    <dialog id="dlgSend">
        <div class="modal">
            <header>
                <h3 id="sendTitle">ë°œì†¡</h3><button onclick="dlgSend.close()">ë‹«ê¸°</button>
            </header>
            <div class="body">
                <div class="form-row">
                    <div class="label">í…œí”Œë¦¿ ì„ íƒ</div>
                    <select id="sendTpl"></select>
                </div>
                <div class="form-row">
                    <div class="label">ë¯¸ë¦¬ë³´ê¸°</div>
                    <div id="tplPreview" class="card" style="padding:10px;white-space:pre-wrap"></div>
                </div>
            </div>
            <div class="footer">
                <button class="primary" id="btnDoSend">ë°œì†¡ ì‹¤í–‰(Mock)</button>
            </div>
        </div>
    </dialog>

    <!-- íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <dialog id="dlgUpload">
        <div class="modal">
            <header>
                <h3>ì„œë¥˜ ì—…ë¡œë“œ</h3><button onclick="dlgUpload.close()">ë‹«ê¸°</button>
            </header>
            <div class="body">
                <div class="form-row">
                    <div class="label">ê³ ê°</div>
                    <div id="uploadTarget"></div>
                </div>
                <div class="form-row">
                    <div class="label">íŒŒì¼</div><input id="fileInput" type="file" accept="application/pdf">
                </div>
                <div class="muted">PDFë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (Mock ì €ì¥: íŒŒì¼ëª…ë§Œ ë³´ê´€)</div>
                <div id="uploadedList"></div>
            </div>
            <div class="footer">
                <button onclick="saveUpload()" class="primary">ì €ì¥</button>
            </div>
        </div>
    </dialog>

    <!-- í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬ (v1.1) -->
    <dialog id="dlgTpl">
        <div class="modal">
            <header>
                <h3>í…œí”Œë¦¿ ê´€ë¦¬</h3><button onclick="dlgTpl.close()">ë‹«ê¸°</button>
            </header>
            <div class="body">
                <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
                    <button id="tplNew">ì‹ ê·œ</button>
                    <button id="tplClone">ë³µì œ</button>
                    <button id="tplDelete">ì‚­ì œ</button>
                    <span class="muted">í™œì„±(1ê°œ)ë§Œ ë°œì†¡ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
                </div>

                <table class="table-mini" id="tplTable">
                    <thead>
                        <tr>
                            <th style="width:60px">í™œì„±</th>
                            <th>ì´ë¦„</th>
                            <th style="width:90px">ìœ í˜•</th>
                            <th>ì œëª©</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

                <div id="tplFormWrap">
                    <div class="form-row">
                        <div class="label">ID</div>
                        <div><input id="tplId" type="text" readonly style="background:#f9fafb;width:220px"></div>
                    </div>
                    <div class="form-row">
                        <div class="label">ì´ë¦„</div>
                        <div><input id="tplName" type="text" style="width:100%"></div>
                    </div>
                    <div class="form-row">
                        <div class="label">ìœ í˜•</div>
                        <div>
                            <label><input type="radio" name="tplType" value="ë©”ì¼"> ë©”ì¼</label>
                            <label style="margin-left:12px"><input type="radio" name="tplType" value="ì•Œë¦¼í†¡"> ì•Œë¦¼í†¡</label>
                        </div>
                    </div>
                    <div class="form-row" id="tplKakaoChannelRow" hidden>
                        <div class="label">ì¹´ì¹´ì˜¤í†¡ ì±„ë„</div>
                        <div><input id="tplKakaoChannel" type="text" value="@ë¹„ì¦ˆí†¡" readonly
                                style="background:#f9fafb;width:220px"></div>
                    </div>
                    <div class="form-row" id="tplCodeRow" hidden>
                        <div class="label">í…œí”Œë¦¿ ì½”ë“œ</div>
                        <div><input id="tplCode" type="text" placeholder="BTK_20241010_A001" style="width:100%"></div>
                    </div>
                    <div class="form-row">
                        <div class="label">ì œëª©</div>
                        <div><input id="tplSubject" type="text" style="width:100%"></div>
                    </div>
                    <div class="form-row">
                        <div class="label">ë³¸ë¬¸</div>
                        <div><textarea id="tplBody" placeholder="í…œí”Œë¦¿ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea></div>
                    </div>
                    <div class="form-row" id="tplAlimPreviewRow" hidden>
                        <div class="label">í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°</div>
                        <div id="tplAlimPreview" class="card"
                            style="padding:10px;white-space:pre-wrap;background:#fafafa"></div>
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px">
                        <button id="tplCancel" class="ghost">ì·¨ì†Œ</button>
                        <button id="tplSave" class="primary">ì €ì¥</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button class="primary" onclick="applyActiveTpl()">í™œì„±í™” ì ìš©</button>
            </div>
        </div>
    </dialog>

    <script>
        // --- Mock ë°ì´í„° -------------------------------------------------
        const sample = [
            { id: "a2m_innopolis", company: "ì—ì´ì— ì´ë…¸í´ë¦¬ìŠ¤(ì£¼)", policyNo: "2025-0022-2722", period: ["2025-02-05", "2026-02-04"], remainDays: 117, amount: 4000, manager: "ì¥*ì§„", phone: "022****9954", email: "leu******@crescty.co.kr", mailSent: "", alimSent: "", status: "ëŒ€ê¸°", memo: "", files: [] },
            { id: "do_dreamsys", company: "ë‘ë“œë¦¼ì‹œìŠ¤í…œ", policyNo: "2025-0026-6550", period: ["2025-10-15", "2026-05-16"], remainDays: 218, amount: null, manager: "ê¹€*íƒ", phone: "undefined", email: "kz1***@hanmail.net", mailSent: "", alimSent: "", status: "ëŒ€ê¸°", memo: "", files: [] },
            { id: "hansunginst", company: "í•œì„±ê³„ê¸°", policyNo: "2024-0500-3647", period: ["2024-10-16", "2025-10-15"], remainDays: 66, amount: null, manager: "ë°•*ìš±", phone: "undefined", email: "han*****@naver.com", mailSent: "", alimSent: "", status: "ê³µì§€ ì™„ë£Œ", memo: "", files: [] },
            { id: "frisbee", company: "ì£¼ì‹íšŒì‚¬ í”„ë¦¬ìŠ¤ë¹„", policyNo: "2024-0544-5990", period: ["2024-12-05", "2025-12-04"], remainDays: 62, amount: null, manager: "ë…¸*ê·œ", phone: "051****3450", email: "***@naver.com", mailSent: "", alimSent: "", status: "ëŒ€ê¸°", memo: "", files: [] },
            { id: "mmk_8_2004", company: "í•œêµ­ì•„ì´ë°”ì´ì˜¤ì œë‹‰ìŠ¤_ì—”ì§€ìí•™", policyNo: "2024-0510-3144", period: ["2024-12-05", "2025-12-04"], remainDays: 141, amount: 300, manager: "ê¹€*ìš°", phone: "undefined", email: "kw***@viaqia.com", mailSent: "", alimSent: "", status: "ë³´ë¥˜", memo: "", files: [] },
            { id: "livlogi", company: "ë¦¬ë¸Œë¡œì§€", policyNo: "2024-0517-3794", period: ["2024-11-25", "2025-11-26"], remainDays: 45, amount: null, manager: "ê¹€*ì°½", phone: "undefined", email: "ri*@gmail.com", mailSent: "", alimSent: "", status: "ëŒ€ê¸°", memo: "", files: [] },
            { id: "ysml626", company: "ì™€ì´ì—ìŠ¤", policyNo: "2024-0533-2690", period: ["2024-10-15", "2025-10-15"], remainDays: 14, amount: null, manager: "ì„*ì—°", phone: "010****1994", email: "glk***@naver.com", mailSent: "", alimSent: "", status: "ëŒ€ê¸°", memo: "", files: [] }
        ];

        let TEMPLATES = JSON.parse(localStorage.getItem("bizmsg_templates") || "null") || [
            {
                id: "t1", name: "ê°±ì‹  ì•ˆë‚´(1ì°¨)", type: "ë©”ì¼", subject: "[ë¹„ì¦ˆí†¡] ì„œë¹„ìŠ¤ ê°±ì‹  ë° ë³´ì¦ë³´í—˜ ì•ˆë‚´",
                body: "ì•ˆë…•í•˜ì„¸ìš”. ë¹„ì¦ˆí†¡ì…ë‹ˆë‹¤.\në³´ì¦ë³´í—˜ ë§Œë£Œê°€ ì˜ˆì •ë˜ì–´ ê°±ì‹  ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\nì²¨ë¶€ëœ ì•½ê´€/ê°±ì‹ ì‹ ì²­ì„œ í™•ì¸ í›„ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤."
            },
            {
                id: "t2", name: "ê°±ì‹  ìš”ì²­(2ì°¨)", type: "ë©”ì¼", subject: "[ì¬ì•ˆë‚´] ë³´ì¦ë³´í—˜ ê°±ì‹  ìš”ì²­",
                body: "D-30 ì¬ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤. ë³´ì¦ë³´í—˜ ì—°ì¥ ë° ì•½ê´€ ë™ì˜ ì„œë¥˜ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤."
            },
            { id: "t3", name: "ì•Œë¦¼í†¡(ìš”ì•½)", type: "ì•Œë¦¼í†¡", subject: "", body: "[ë¹„ì¦ˆí†¡] ë³´ì¦ë³´í—˜ D-30. ë©”ì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”." }
        ];
        // í™œì„± í…œí”Œë¦¿ (ë©”ì¼/ì•Œë¦¼í†¡ ê°ê° 1ê°œ ê°€ì •)
        let activeTplId = localStorage.getItem("activeTplId") || "t1";

        // --- ìƒíƒœ / ë°ì´í„° í•¸ë“¤ë§ ----------------------------------------
        let state = {
            data: JSON.parse(localStorage.getItem("bizmsg_gx_data") || "null") || sample,
            page: 1, pageSize: 10, sortKey: null, sortDir: 1,
            filters: { id: "", company: "", due30: false, due60: false, status: "", sent: "", from: "", to: "" }
        };

        function maskEmail(e) { if (!e || e === 'undefined') return 'undefined'; const [id, domain] = e.split("@"); if (!domain) return e; return id.slice(0, 2) + "***@" + domain; }
        function maskPhone(p) { if (!p || p === 'undefined') return 'undefined'; return p.replace(/(\d{3})(\d+)(\d{4})/, (m, a, b, c) => a + "-**" + c); }
        function maskName(n) { if (!n) return ""; return n[0] + "*" + (n.length > 2 ? "*" : ""); }
        function formatAmount(a) { if (a == null || a === undefined || a === '') return "undefined"; return Number(a).toLocaleString(); }
        function formatRemain(d) { const s = d > 0 ? `${d}ì¼ ë‚¨ìŒ` : (d === 0 ? "ë‹¹ì¼" : "ë§Œë£Œ"); return s; }
        function between(dateStr, from, to) {
            if (!from && !to) return true;
            const d = new Date(dateStr);
            if (from && d < new Date(from)) return false;
            if (to && d > new Date(to)) return false;
            return true;
        }

        function persist() { localStorage.setItem("bizmsg_gx_data", JSON.stringify(state.data)); localStorage.setItem("activeTplId", activeTplId); }

        // --- ë Œë”ë§ ------------------------------------------------------
        function render() {
            const tbody = document.querySelector("#dataGrid tbody");
            tbody.innerHTML = "";
            const filters = state.filters;
            let rows = state.data.filter(r => {
                if (filters.id && !r.id.toLowerCase().includes(filters.id.toLowerCase())) return false;
                if (filters.company && !r.company.includes(filters.company)) return false;
                if (filters.due30 && !(r.remainDays <= 30)) return false;
                if (filters.due60 && !(r.remainDays <= 60)) return false;
                if (filters.status && r.status !== filters.status) return false;
                if (filters.sent === "mail" && !r.mailSent) return false;
                if (filters.sent === "alim" && !r.alimSent) return false;
                if (filters.sent === "none" && (r.mailSent || r.alimSent)) return false;
                // date filter on policy end
                const end = r.period[1];
                if (!between(end, filters.from, filters.to)) return false;
                return true;
            });

            // sort
            if (state.sortKey) {
                rows.sort((a, b) => {
                    const k = state.sortKey, dir = state.sortDir;
                    let va = a[k], vb = b[k];
                    if (k === "period") { va = a.period[1]; vb = b.period[1]; }
                    if (k === "remain") { va = a.remainDays; vb = b.remainDays; }
                    if (k === "amount") { va = a.amount ?? 0; vb = b.amount ?? 0; }
                    if (typeof va === "string") va = va.toLowerCase();
                    if (typeof vb === "string") vb = vb.toLowerCase();
                    return (va > vb ? 1 : va < vb ? -1 : 0) * dir;
                });
            }

            const total = rows.length;
            document.getElementById("resultInfo").textContent = `ì´ ${total}ê±´`;

            // pagination
            const start = (state.page - 1) * state.pageSize;
            rows.slice(start, start + state.pageSize).forEach((r, idx) => {
                const tr = document.createElement("tr");
                if (r.remainDays === 45 || r.remainDays === 30 || r.remainDays <= 30) tr.classList.add("highlight");
                tr.innerHTML = `
      <td><input type="checkbox" class="rowcheck" data-id="${r.id}"></td>
      <td><a href="#" class="lnkDetail" data-id="${r.id}">${r.id}</a></td>
      <td>${r.company}</td>
      <td>${r.policyNo || ""}</td>
      <td>${r.period[0]} ~ ${r.period[1]}</td>
      <td>${formatRemain(r.remainDays)}</td>
      <td>${formatAmount(r.amount)}</td>
      <td>${maskName(r.manager)}</td>
      <td>${maskPhone(r.phone)}</td>
      <td>${maskEmail(r.email)}</td>
      <td>${r.mailSent || ""}</td>
      <td>${r.alimSent || ""}</td>
      <td>
        <select class="selStatus" data-id="${r.id}">
          ${["ëŒ€ê¸°", "ê³µì§€ ì™„ë£Œ", "ê°±ì‹  ì™„ë£Œ", "ë³´ë¥˜"].map(s => `<option ${s === r.status ? "selected" : ""}>${s}</option>`).join("")}
        </select>
      </td>
      <td>
        <div class="row-actions">
          <button data-id="${r.id}" class="btnMemo">ë©”ëª¨</button>
          <button data-id="${r.id}" class="btnUpload">ì„œë¥˜ ì—…ë¡œë“œ</button>
          <button data-id="${r.id}" class="btnMail">ë©”ì¼</button>
          <button data-id="${r.id}" class="btnAlim">ì•Œë¦¼í†¡</button>
        </div>
      </td>
    `;
                tbody.appendChild(tr);
            });

            renderPager(total);
            bindRowEvents();
            document.getElementById("activeTplName").textContent = TEMPLATES.find(t => t.id === activeTplId)?.name || "";
        }

        function renderPager(total) {
            const pager = document.getElementById("pager");
            const pages = Math.max(1, Math.ceil(total / state.pageSize));
            const cur = Math.min(state.page, pages);
            state.page = cur;
            let html = "";
            html += `<span class="muted">í˜ì´ì§€ ${cur}/${pages}</span>`;
            html += `<button ${cur === 1 ? "disabled" : ""} data-p="prev">ì´ì „</button>`;
            for (let i = 1; i <= pages && i <= 7; i++) {
                html += `<button data-p="${i}" ${i === cur ? 'class="primary"' : ""}>${i}</button>`;
            }
            html += `<button ${cur === pages ? "disabled" : ""} data-p="next">ë‹¤ìŒ</button>`;
            pager.innerHTML = html;
            pager.querySelectorAll("button").forEach(b => {
                b.onclick = () => {
                    const p = b.getAttribute("data-p");
                    if (p === "prev") state.page = Math.max(1, state.page - 1);
                    else if (p === "next") state.page += 1;
                    else state.page = parseInt(p);
                    render();
                };
            });
        }

        function bindRowEvents() {
            document.querySelectorAll(".lnkDetail").forEach(a => a.onclick = (e) => { e.preventDefault(); openDetail(a.dataset.id) });
            document.querySelectorAll(".btnMemo").forEach(btn => btn.onclick = () => openMemo(btn.dataset.id));
            document.querySelectorAll(".btnUpload").forEach(btn => btn.onclick = () => openUpload(btn.dataset.id));
            document.querySelectorAll(".btnMail").forEach(btn => btn.onclick = () => openSend(btn.dataset.id, "mail"));
            document.querySelectorAll(".btnAlim").forEach(btn => btn.onclick = () => openSend(btn.dataset.id, "alim"));
            document.querySelectorAll(".selStatus").forEach(sel => sel.onchange = () => {
                const r = state.data.find(x => x.id === sel.dataset.id); r.status = sel.value; persist(); render();
            });
            document.getElementById("checkAll").onclick = (e) => {
                document.querySelectorAll(".rowcheck").forEach(c => c.checked = e.target.checked);
            }
        }

        // --- ìƒì„¸ ë³´ê¸° ---------------------------------------------------
        let currentId = null;
        function openDetail(id) {
            currentId = id;
            const r = state.data.find(x => x.id === id);
            const b = document.getElementById("tab-basic");
            const i = document.getElementById("tab-ins");
            const l = document.getElementById("tab-logs");
            const reply = document.getElementById("tab-reply");
            b.innerHTML = `
    <div class="form-row"><div class="label">ê³ ê° ì•„ì´ë””</div><div>${r.id}</div></div>
    <div class="form-row"><div class="label">íšŒì‚¬ëª…</div><div>${r.company}</div></div>
    <div class="form-row"><div class="label">ë‹´ë‹¹ì</div><div>${maskName(r.manager)} / ${maskPhone(r.phone)} / ${maskEmail(r.email)}</div></div>
    <div class="form-row"><div class="label">ìƒíƒœ</div><div>${r.status}</div></div>
  `;
            i.innerHTML = `
    <div class="form-row"><div class="label">ì¦ê¶Œë²ˆí˜¸</div><div>${r.policyNo || ""}</div></div>
    <div class="form-row"><div class="label">ê¸°ê°„</div><div>${r.period[0]} ~ ${r.period[1]}</div></div>
    <div class="form-row"><div class="label">ë‚¨ì€ ê¸°ê°„</div><div>${formatRemain(r.remainDays)}</div></div>
    <div class="form-row"><div class="label">ê¸ˆì•¡</div><div>${formatAmount(r.amount)}</div></div>
  `;
            l.innerHTML = `
    <table class="table-mini">
      <thead><tr><th>êµ¬ë¶„</th><th>ì¼ì‹œ</th><th>ë‚´ìš©</th></tr></thead>
      <tbody>
        ${r.mailSent ? `<tr><td>ë©”ì¼</td><td>${r.mailSent}</td><td>${TEMPLATES.find(t => t.id === activeTplId)?.name}</td></tr>` : ""}
        ${r.alimSent ? `<tr><td>ì•Œë¦¼í†¡</td><td>${r.alimSent}</td><td>${TEMPLATES.find(t => t.type === 'ì•Œë¦¼í†¡')?.name || ''}</td></tr>` : ""}
      </tbody>
    </table>
  `;
            reply.innerHTML = `
    <div class="form-row"><div class="label">ë©”ëª¨</div><div>${r.memo || "-"}</div></div>
    <div class="form-row"><div class="label">ì²¨ë¶€</div><div>${(r.files || []).map(f => `<span class="badge">${f}</span>`).join(" ") || "-"}</div></div>
  `;

            // tab behavior
            const tabs = document.querySelectorAll("#dlgDetail .tabs button");
            tabs.forEach(btn => btn.onclick = () => {
                tabs.forEach(x => x.classList.remove("active"));
                btn.classList.add("active");
                document.querySelectorAll("#dlgDetail .tab-panel").forEach(p => p.hidden = true);
                document.getElementById("tab-" + btn.dataset.tab).hidden = false;
            });
            document.getElementById("btnDetailMail").onclick = () => openSend(id, "mail");
            document.getElementById("btnDetailAlim").onclick = () => openSend(id, "alim");
            dlgDetail.showModal();
        }
        function closeDetail() { dlgDetail.close(); }

        // --- ë©”ëª¨ ---------------------------------------------------------
        let memoId = null;
        function openMemo(id) {
            memoId = id;
            document.getElementById("memoTarget").textContent = id;
            const r = state.data.find(x => x.id === id);
            document.getElementById("memoText").value = r.memo || "";
            dlgMemo.showModal();
        }
        function saveMemo() {
            const r = state.data.find(x => x.id === memoId);
            r.memo = document.getElementById("memoText").value;
            persist(); dlgMemo.close(); render();
        }

        // --- íŒŒì¼ ì—…ë¡œë“œ --------------------------------------------------
        let uploadId = null;
        function openUpload(id) {
            uploadId = id;
            document.getElementById("uploadTarget").textContent = id;
            document.getElementById("fileInput").value = "";
            const r = state.data.find(x => x.id === id);
            document.getElementById("uploadedList").innerHTML = (r.files || []).map(f => `<span class="badge">${f}</span>`).join(" ");
            dlgUpload.showModal();
        }
        function saveUpload() {
            const inp = document.getElementById("fileInput");
            if (!inp.files.length) { alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            const name = inp.files[0].name;
            const r = state.data.find(x => x.id === uploadId);
            if (!r.files) r.files = [];
            r.files.push(name);
            persist(); dlgUpload.close(); render();
        }

        // --- ë°œì†¡ ---------------------------------------------------------
        let sendType = "mail", sendId = null;
        function openSend(id, type) {
            sendType = type; sendId = id;
            const sel = document.getElementById("sendTpl");
            const list = TEMPLATES.filter(t => type === "mail" ? t.type === "ë©”ì¼" : t.type === "ì•Œë¦¼í†¡");
            sel.innerHTML = list.map(t => `<option value="${t.id}" ${t.id === activeTplId ? "selected" : ""}>${t.name}</option>`).join("");
            updatePreview();
            document.getElementById("sendTitle").textContent = type === "mail" ? "ë©”ì¼ ë°œì†¡" : "ì•Œë¦¼í†¡ ë°œì†¡";
            document.getElementById("btnDoSend").onclick = doSend;
            dlgSend.showModal();
        }
        function updatePreview() {
            const id = document.getElementById("sendTpl").value;
            const t = TEMPLATES.find(x => x.id === id);
            document.getElementById("tplPreview").textContent = (t.subject ? (t.subject + "\n\n") : "") + t.body;
        }
        document.getElementById("sendTpl").addEventListener("change", updatePreview);

        function doSend() {
            const r = state.data.find(x => x.id === sendId);
            const now = new Date().toISOString().slice(0, 16).replace("T", " ");
            if (sendType === "mail") r.mailSent = now; else r.alimSent = now;
            // ìë™ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µì§€ ì™„ë£Œ)
            if (r.status === "ëŒ€ê¸°") r.status = "ê³µì§€ ì™„ë£Œ";
            persist(); dlgSend.close(); render();
        }

        // --- í…œí”Œë¦¿ ê´€ë¦¬ --------------------------------------------------
        function saveTplStore() {
            localStorage.setItem("bizmsg_templates", JSON.stringify(TEMPLATES));
            localStorage.setItem("activeTplId", activeTplId);
            const active = TEMPLATES.find(t => t.id === activeTplId);
            if (active) document.getElementById("activeTplName").textContent = active.name;
        }

        let currentTplId = null;

        function openTpl() {
            renderTplTable();
            loadTplForm(null); // ì‹ ê·œ ì‘ì„± ìƒíƒœë¡œ í¼ ì´ˆê¸°í™”
            dlgTpl.showModal();
        }

        function renderTplTable() {
            const tb = document.querySelector("#tplTable tbody");
            tb.innerHTML = "";
            TEMPLATES.forEach(t => {
                tb.innerHTML += `
      <tr data-id="${t.id}" class="tpl-row">
        <td style="text-align:center"><input type="radio" name="activeTpl" value="${t.id}" ${t.id === activeTplId ? "checked" : ""}></td>
        <td>${t.name}</td>
        <td>${t.type}</td>
        <td>${t.subject || "-"}</td>
      </tr>`;
            });
            // í–‰ í´ë¦­ ì‹œ í¼ì— ë¡œë“œ
            document.querySelectorAll(".tpl-row").forEach(tr => {
                tr.onclick = () => loadTplForm(tr.getAttribute("data-id"));
            });
        }

        function createTplId() { return `t${Date.now()}`; }

        function loadTplForm(id) {
            currentTplId = id;
            const t = TEMPLATES.find(x => x.id === id) || { id: createTplId(), name: "", type: "ë©”ì¼", subject: "", body: "", tplCode: "" };
            document.getElementById("tplId").value = t.id;
            document.getElementById("tplName").value = t.name;
            document.querySelectorAll('input[name="tplType"]').forEach(r => r.checked = (r.value === t.type));
            document.getElementById("tplSubject").value = t.subject || "";
            document.getElementById("tplBody").value = t.body || "";
            document.getElementById("tplCode").value = t.tplCode || "";
            const isAlim = t.type === "ì•Œë¦¼í†¡";
            document.getElementById("tplKakaoChannelRow").hidden = !isAlim;
            document.getElementById("tplCodeRow").hidden = !isAlim;
            document.getElementById("tplAlimPreviewRow").hidden = !isAlim;
            if (isAlim) {
                document.getElementById("tplAlimPreview").textContent = t.body || "(ë“±ë¡ëœ í…œí”Œë¦¿ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.)";
            }
        }

        // ë²„íŠ¼: ì‹ ê·œ/ë³µì œ/ì‚­ì œ/ì·¨ì†Œ/ì €ì¥
        document.getElementById("tplNew").onclick = () => loadTplForm(null);

        document.getElementById("tplClone").onclick = () => {
            if (!currentTplId) { alert("ë³µì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            const src = TEMPLATES.find(t => t.id === currentTplId);
            const clone = { ...src, id: createTplId(), name: src.name + " ì‚¬ë³¸" };
            TEMPLATES.push(clone);
            saveTplStore(); renderTplTable(); loadTplForm(clone.id);
        };

        document.getElementById("tplDelete").onclick = () => {
            const id = document.getElementById("tplId").value;
            const idx = TEMPLATES.findIndex(t => t.id === id);
            if (idx < 0) { alert("ì‚­ì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            if (TEMPLATES[idx].id === activeTplId) { alert("í™œì„± í…œí”Œë¦¿ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            TEMPLATES.splice(idx, 1);
            saveTplStore(); renderTplTable(); loadTplForm(null);
        };

        document.getElementById("tplCancel").onclick = () => loadTplForm(null);

        document.getElementById("tplSave").onclick = () => {
            const id = document.getElementById("tplId").value || createTplId();
            const name = document.getElementById("tplName").value.trim();
            const type = [...document.querySelectorAll('input[name="tplType"]')].find(r => r.checked)?.value || "ë©”ì¼";
            const subject = document.getElementById("tplSubject").value;
            const body = document.getElementById("tplBody").value;
            const tplCode = document.getElementById("tplCode").value.trim();
            if (!name) { alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
            if (type === "ì•Œë¦¼í†¡" && !tplCode) { alert("ì•Œë¦¼í†¡ í…œí”Œë¦¿ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            const i = TEMPLATES.findIndex(t => t.id === id);
            const newTpl = { id, name, type, subject, body, tplCode };
            if (i >= 0) TEMPLATES[i] = { ...TEMPLATES[i], ...newTpl }; else TEMPLATES.push(newTpl);
            saveTplStore();
            renderTplTable();
            loadTplForm(id);
        };

        function applyActiveTpl() {
            const sel = document.querySelector('input[name="activeTpl"]:checked');
            if (!sel) { alert("í™œì„± í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            activeTplId = sel.value;
            saveTplStore();
            dlgTpl.close();
        }

        // --- ê²€ìƒ‰/ì •ë ¬/ì—‘ì…€(Mock) ----------------------------------------
        function collectFilters() {
            state.filters.id = document.getElementById("qId").value.trim();
            state.filters.company = document.getElementById("qCompany").value.trim();
            state.filters.due30 = document.getElementById("qDue30").checked;
            state.filters.due60 = document.getElementById("qDue60").checked;
            state.filters.status = document.getElementById("qStatus").value;
            state.filters.sent = document.getElementById("qSent").value;
            state.filters.from = document.getElementById("qFrom").value;
            state.filters.to = document.getElementById("qTo").value;
        }
        document.getElementById("btnSearch").onclick = () => { collectFilters(); state.page = 1; render(); };
        document.getElementById("btnReset").onclick = () => {
            ["qId", "qCompany", "qFrom", "qTo"].forEach(id => document.getElementById(id).value = "");
            ["qDue30", "qDue60"].forEach(id => document.getElementById(id).checked = false);
            document.getElementById("qStatus").value = "";
            document.getElementById("qSent").value = "";
            collectFilters(); state.page = 1; render();
        };

        document.querySelectorAll("#dataGrid thead th.sort").forEach(th => {
            th.onclick = () => {
                const k = th.dataset.key;
                if (state.sortKey === k) state.sortDir *= -1; else { state.sortKey = k; state.sortDir = 1; }
                render();
            };
        });

        // Bulk send
        function getCheckedIds() {
            return [...document.querySelectorAll(".rowcheck:checked")].map(c => c.dataset.id);
        }
        document.getElementById("btnBulkMail").onclick = () => {
            const ids = getCheckedIds(); if (ids.length === 0) return alert("ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");
            ids.forEach(id => { const r = state.data.find(x => x.id === id); r.mailSent = new Date().toISOString().slice(0, 16).replace("T", " "); if (r.status === "ëŒ€ê¸°") r.status = "ê³µì§€ ì™„ë£Œ"; });
            persist(); render();
        };
        document.getElementById("btnBulkAlim").onclick = () => {
            const ids = getCheckedIds(); if (ids.length === 0) return alert("ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");
            ids.forEach(id => { const r = state.data.find(x => x.id === id); r.alimSent = new Date().toISOString().slice(0, 16).replace("T", " "); if (r.status === "ëŒ€ê¸°") r.status = "ê³µì§€ ì™„ë£Œ"; });
            persist(); render();
        };

        // Export CSV Mock
        document.getElementById("btnExport").onclick = () => {
            const header = ["id", "company", "policyNo", "periodStart", "periodEnd", "remainDays", "amount", "manager", "phone", "email", "mailSent", "alimSent", "status"];
            const rows = state.data.map(r => [r.id, r.company, r.policyNo, r.period[0], r.period[1], r.remainDays, r.amount ?? "", r.manager, r.phone, r.email, r.mailSent, r.alimSent, r.status].join(","));
            const blob = new Blob([header.join(",") + "\n" + rows.join("\n")], { type: "text/csv" });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "renewal_export_mock.csv"; a.click();
        };

        // open dialogs
        document.getElementById("btnTpl").onclick = openTpl;

        // Init
        render();
    </script>
</body>

</html>